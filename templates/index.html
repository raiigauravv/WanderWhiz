<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WanderWhiz</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body>
    <div class="header">
      <h1>üåê WanderWhiz ‚Äì Discover Hidden Gems</h1>
      <p class="subtitle">
        Search for hidden gems in any city around the world!
      </p>
    </div>

    <!-- Trippi AI Travel Assistant -->
    <div class="gpt-section">
      <h2>üåé Meet Trippi - Your AI Travel Companion</h2>
      <p class="gpt-subtitle">
        Tell Trippi what you want to explore! I'll plan your perfect trip with
        places, routes, and budget estimates.
      </p>
      <form action="/gpt-assist" method="POST" class="gpt-form">
        <input
          type="text"
          name="prompt"
          placeholder='Try: "Plan me a chill Saturday in Montreal with cozy caf√©s, parks, and bookstores"'
          value="{{ gpt_prompt or '' }}"
          required
        />
        <button type="submit">‚ú® Let Trippi Plan My Trip</button>
      </form>
      {% if gpt_prompt %}
      <div class="gpt-result">
        <p>ü§ñ <strong>Trippi understood:</strong> "{{ gpt_prompt }}"</p>
        <p>
          üìç Found {{ places|length }} places in {{ city }} for: {{ interest }}
        </p>
      </div>
      {% endif %} {% if error %}
      <div class="error-message">
        <p>‚ùå {{ error }}</p>
      </div>
      {% endif %}
    </div>

    <div
      class="divider"
      style="
        display: flex;
        align-items: center;
        margin: 40px auto;
        max-width: 900px;
      "
    >
      <div
        style="
          flex: 1;
          height: 2px;
          background: linear-gradient(
            90deg,
            transparent,
            rgba(230, 126, 34, 0.5),
            transparent
          );
        "
      ></div>
      <span
        style="
          margin: 0 20px;
          color: #7f8c8d;
          font-weight: 600;
          font-size: 1.1rem;
          background: rgba(255, 255, 255, 0.9);
          padding: 10px 20px;
          border-radius: 25px;
          border: 2px solid rgba(230, 126, 34, 0.2);
        "
        >OR</span
      >
      <div
        style="
          flex: 1;
          height: 2px;
          background: linear-gradient(
            90deg,
            transparent,
            rgba(230, 126, 34, 0.5),
            transparent
          );
        "
      ></div>
    </div>

    <!-- Enhanced Manual Search -->
    <div
      class="manual-section"
      style="
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        color: #2c3e50;
        padding: 40px 30px;
        margin: 30px auto;
        border-radius: 20px;
        max-width: 900px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(230, 126, 34, 0.2);
      "
    >
      <h3
        style="
          color: #2c3e50;
          font-size: 1.8rem;
          font-weight: 700;
          text-align: center;
          margin-bottom: 25px;
          background: linear-gradient(135deg, #e67e22, #d35400);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        "
      >
        üîç Manual Search
      </h3>
      <form
        action="/"
        method="POST"
        class="search-form"
        style="
          display: flex;
          justify-content: center;
          gap: 15px;
          flex-wrap: wrap;
        "
      >
        <input
          type="text"
          name="city"
          placeholder="Enter city (e.g., Lisbon)"
          value="{{ city }}"
          required
          style="
            padding: 18px 25px;
            border: 2px solid rgba(230, 126, 34, 0.2);
            border-radius: 50px;
            font-size: 16px;
            min-width: 250px;
            flex: 1;
            max-width: 300px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #2c3e50;
            font-weight: 500;
          "
        />
        <input
          type="text"
          name="interest"
          placeholder="Enter interest (e.g., bookstores)"
          value="{{ interest }}"
          required
          style="
            padding: 18px 25px;
            border: 2px solid rgba(230, 126, 34, 0.2);
            border-radius: 50px;
            font-size: 16px;
            min-width: 250px;
            flex: 1;
            max-width: 300px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #2c3e50;
            font-weight: 500;
          "
        />
        <button
          type="submit"
          style="
            padding: 18px 30px;
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.3);
            position: relative;
            overflow: hidden;
          "
        >
          Find Hidden Gems
        </button>
      </form>
    </div>

    <!-- üìä Platform Statistics Section -->
    <div
      class="stats-section"
      style="
        margin: 30px auto;
        max-width: 900px;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        text-align: center;
      "
    >
      <h3
        style="
          color: white;
          font-size: 1.8rem;
          font-weight: 700;
          margin-bottom: 25px;
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        "
      >
        üåü Join Thousands of Happy Travelers
      </h3>
      <div
        id="platform-stats"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
          gap: 20px;
          margin-top: 20px;
        "
      >
        <div
          class="stat-item"
          style="
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
          "
        >
          <div
            class="stat-number"
            style="font-size: 2rem; font-weight: bold; color: #ffd700"
          >
            1,247
          </div>
          <div
            class="stat-label"
            style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px"
          >
            Trips Created
          </div>
        </div>
        <div
          class="stat-item"
          style="
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
          "
        >
          <div
            class="stat-number"
            style="font-size: 2rem; font-weight: bold; color: #ff6b6b"
          >
            45.6K
          </div>
          <div
            class="stat-label"
            style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px"
          >
            KM Optimized
          </div>
        </div>
        <div
          class="stat-item"
          style="
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
          "
        >
          <div
            class="stat-number"
            style="font-size: 2rem; font-weight: bold; color: #4ecdc4"
          >
            8,934
          </div>
          <div
            class="stat-label"
            style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px"
          >
            Places Visited
          </div>
        </div>
        <div
          class="stat-item"
          style="
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
          "
        >
          <div
            class="stat-number"
            style="font-size: 2rem; font-weight: bold; color: #95e5a6"
          >
            3.5K
          </div>
          <div
            class="stat-label"
            style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px"
          >
            Hours Saved
          </div>
        </div>
      </div>
    </div>

    <!-- üéØ Demo Trips Section -->
    <div
      class="demo-trips-section"
      style="
        margin: 30px auto;
        max-width: 900px;
        padding: 30px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(230, 126, 34, 0.2);
      "
    >
      <h3
        style="
          color: #2c3e50;
          font-size: 1.8rem;
          font-weight: 700;
          text-align: center;
          margin-bottom: 25px;
          background: linear-gradient(135deg, #e67e22, #d35400);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        "
      >
        ‚ú® Try Our Demo Trips
      </h3>
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
        "
      >
        <div
          class="demo-trip-card"
          style="
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
          "
          onclick="loadDemoTrip('demo-paris-romantic')"
        >
          <h4 style="margin: 0 0 10px 0; font-size: 1.2rem">
            ‚ù§Ô∏è Romantic Paris
          </h4>
          <p style="margin: 0; font-size: 0.9rem; opacity: 0.9">
            Cozy cafes, museums & landmarks
          </p>
          <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8">
            6 places ‚Ä¢ $140/person
          </div>
        </div>

        <div
          class="demo-trip-card"
          style="
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            color: #2c3e50;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.3);
          "
          onclick="loadDemoTrip('demo-tokyo-foodie')"
        >
          <h4 style="margin: 0 0 10px 0; font-size: 1.2rem">üçú Tokyo Foodie</h4>
          <p style="margin: 0; font-size: 0.9rem; opacity: 0.8">
            Street food & authentic restaurants
          </p>
          <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7">
            6 places ‚Ä¢ $160/person
          </div>
        </div>

        <div
          class="demo-trip-card"
          style="
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            color: #2c3e50;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 236, 210, 0.3);
          "
          onclick="loadDemoTrip('demo-nyc-hipster')"
        >
          <h4 style="margin: 0 0 10px 0; font-size: 1.2rem">‚òï NYC Hipster</h4>
          <p style="margin: 0; font-size: 0.9rem; opacity: 0.8">
            Coffee shops & art galleries
          </p>
          <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7">
            6 places ‚Ä¢ $98/person
          </div>
        </div>
      </div>
    </div>

    <!-- üó∫Ô∏è Enhanced Saved Trips Section -->
    <div
      class="saved-trips-section"
      style="
        margin: 30px auto;
        max-width: 900px;
        padding: 30px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(230, 126, 34, 0.2);
      "
    >
      <h3
        style="
          color: #2c3e50;
          font-size: 1.8rem;
          font-weight: 700;
          text-align: center;
          margin-bottom: 25px;
          background: linear-gradient(135deg, #e67e22, #d35400);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        "
      >
        üíæ Your Saved Trips
      </h3>
      <div id="saved-trips-container">
        <p style="color: #7f8c8d; text-align: center; font-size: 1.1rem">
          Loading your saved adventures...
        </p>
      </div>
    </div>

    <div class="legend">
      {% if places %}
      <span class="legend-item"
        >üéØ Discovered Places ({{ places|length }})</span
      >
      {% else %}
      <span class="legend-item">üî¥ Landmarks</span>
      <span class="legend-item">üü¢ Markets</span>
      <span class="legend-item">üü£ Castles</span>
      <span class="legend-item">üîµ Cultural Areas</span>
      <span class="legend-item">üü† Discovered Places</span>
      {% endif %}
    </div>

    <div id="map" data-lat="{{ lat }}" data-lng="{{ lng }}"></div>

    {% if places %}
    <div
      class="itinerary-section"
      style="
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        margin: 30px auto;
        max-width: 1000px;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(230, 126, 34, 0.2);
      "
    >
      <form method="POST" action="/itinerary" class="itinerary-form">
        <h3
          style="
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #e67e22, #d35400);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          "
        >
          üéØ Select places to include in your itinerary
        </h3>
        <input
          type="hidden"
          name="all_places_json"
          value="{{ places_json if places_json else '[]' }}"
        />
        <input
          type="hidden"
          name="city"
          value="{{ city }}"
        />
        <div
          class="places-list"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
          "
        >
          {% for place in places %}
          <label
            class="place-item"
            style="
              background: linear-gradient(135deg, #ffffff, #f8f9fa);
              border: 2px solid rgba(230, 126, 34, 0.1);
              border-radius: 15px;
              padding: 20px;
              cursor: pointer;
              transition: all 0.3s ease;
              display: block;
              position: relative;
              overflow: hidden;
            "
          >
            <input
              type="checkbox"
              name="place_ids"
              value="{{ loop.index0 }}"
              style="margin-right: 15px; transform: scale(1.2)"
            />
            <div class="place-info">
              <strong
                style="
                  color: #2c3e50;
                  font-size: 1.2rem;
                  display: block;
                  margin-bottom: 8px;
                "
                >{{ place.name }}</strong
              >
              {% if place.rating %}
              <div style="margin-bottom: 8px">
                <span
                  class="rating"
                  style="
                    background: linear-gradient(135deg, #f39c12, #e67e22);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.9rem;
                    font-weight: 600;
                  "
                  >{{ place.rating }} ‚≠ê</span
                >
              </div>
              {% endif %}
              <div
                class="address"
                style="
                  color: #7f8c8d;
                  font-size: 0.95rem;
                  margin-bottom: 8px;
                  line-height: 1.4;
                "
              >
                üìç {{ place.formatted_address or place.vicinity or 'Address not
                available' }}
              </div>
              {% if place.price_level %}
              <div
                class="price"
                style="color: #e67e22; font-weight: bold; font-size: 0.9rem"
              >
                üí∞ {% for i in range(place.price_level) %}${% endfor %} {% if
                place.price_level == 1 %}(Budget-Friendly) {% elif
                place.price_level == 2 %}(Moderate) {% elif place.price_level ==
                3 %}(Expensive) {% elif place.price_level >= 4 %}(Very
                Expensive) {% endif %}
              </div>
              {% endif %}
            </div>
          </label>
          {% endfor %}
        </div>
        <div style="text-align: center">
          <button
            type="submit"
            class="build-itinerary-btn"
            style="
              padding: 20px 40px;
              background: linear-gradient(135deg, #e67e22, #d35400);
              color: white;
              border: none;
              border-radius: 50px;
              cursor: pointer;
              font-size: 18px;
              font-weight: 700;
              transition: all 0.3s ease;
              box-shadow: 0 10px 30px rgba(230, 126, 34, 0.3);
              position: relative;
              overflow: hidden;
            "
          >
            üéØ Build Optimized Itinerary
          </button>
        </div>
      </form>
    </div>
    {% endif %}

    <script>
      // Pass data from Flask to JavaScript safely
      try {
        window.placesData = {% if places %}{{ places | tojson | safe }}{% else %}[]{% endif %};
        window.mapCenter = {
          lat: {% if lat %}{{ lat }}{% else %}43.65107{% endif %},
          lng: {% if lng %}{{ lng }}{% else %}-79.347015{% endif %}
        };
      } catch (e) {
        console.warn('Error loading places data:', e);
        window.placesData = [];
        window.mapCenter = { lat: 43.65107, lng: -79.347015 };
      }

      // üó∫Ô∏è Phase 4.5 - Load Saved Trips
      async function loadSavedTrips() {
        try {
          const response = await fetch('/firebase-get-itineraries');
          const data = await response.json();

          const container = document.getElementById('saved-trips-container');

          if (data.itineraries && data.itineraries.length > 0) {
            container.innerHTML = data.itineraries.map(trip => `
              <div class="saved-trip-card" style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${trip.name || trip.city || 'Unnamed Trip'}</h4>
                  <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    üìç ${trip.city} ‚Ä¢ ${trip.places ? trip.places.length : 0} places ‚Ä¢ ${new Date(trip.created_at).toLocaleDateString()}
                  </p>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button onclick="loadTrip('${trip.id}')" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    üîÑ Load Trip
                  </button>
                  <button onclick="deleteTrip('${trip.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">No saved trips yet. Create your first itinerary!</p>';
          }
        } catch (error) {
          console.error('Error loading saved trips:', error);
          document.getElementById('saved-trips-container').innerHTML = '<p style="color: #e74c3c;">Failed to load saved trips</p>';
        }
      }

      async function loadTrip(tripId) {
        try {
          // Show loading state
          const button = event.target;
          const originalText = button.innerHTML;
          button.innerHTML = '‚è≥ Loading...';
          button.disabled = true;

          // Redirect directly to the trip view route
          window.location.href = `/trip/${tripId}`;

        } catch (error) {
          console.error('Error loading trip:', error);
          alert('Failed to load trip');

          // Reset button state
          const button = event.target;
          button.innerHTML = 'üîÑ Load Trip';
          button.disabled = false;
        }
      }

      async function deleteTrip(tripId) {
        try {
          // Confirm with user
          const confirmed = confirm('Are you sure you want to delete this trip? This action cannot be undone.');
          if (!confirmed) return;

          // Show loading state
          const button = event.target;
          const originalText = button.innerHTML;
          button.innerHTML = '‚è≥ Deleting...';
          button.disabled = true;

          const response = await fetch(`/delete-itinerary/${tripId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              alert('Trip deleted successfully!');
              // Refresh the saved trips list
              loadSavedTrips();
            } else {
              throw new Error(data.message || 'Failed to delete trip');
            }
          } else {
            throw new Error('Server error');
          }

        } catch (error) {
          console.error('Error deleting trip:', error);
          alert(`Failed to delete trip: ${error.message}`);

          // Reset button state
          const button = event.target;
          button.innerHTML = 'üóëÔ∏è Delete';
          button.disabled = false;
        }
      }

      // Load saved trips when page loads
      document.addEventListener('DOMContentLoaded', loadSavedTrips);

      // üöÄ Demo Trip Functions
      function loadDemoTrip(tripId) {
        // Show loading state
        document.querySelectorAll('.demo-trip-card').forEach(card => {
          card.style.opacity = '0.6';
          card.style.pointerEvents = 'none';
        });

        // Navigate to demo trip
        window.location.href = `/demo-trip/${tripId}`;
      }

      // üìä Load Platform Statistics
      async function loadPlatformStats() {
        try {
          const response = await fetch('/platform-stats');
          const data = await response.json();

          if (data.stats) {
            const stats = data.stats;
            const statsContainer = document.getElementById('platform-stats');

            if (statsContainer) {
              statsContainer.innerHTML = `
                <div class="stat-item" style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                  <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: #ffd700;">${stats.total_trips.toLocaleString()}</div>
                  <div class="stat-label" style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Trips Created</div>
                </div>
                <div class="stat-item" style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                  <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: #ff6b6b;">${stats.total_distance_km.toLocaleString()}K</div>
                  <div class="stat-label" style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">KM Optimized</div>
                </div>
                <div class="stat-item" style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                  <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: #4ecdc4;">${stats.total_places.toLocaleString()}</div>
                  <div class="stat-label" style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Places Visited</div>
                </div>
                <div class="stat-item" style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                  <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: #95e5a6;">3.5K</div>
                  <div class="stat-label" style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Hours Saved</div>
                </div>
              `;
            }
          }
        } catch (error) {
          console.log('Using default stats');
        }
      }

      // üé® Demo Card Hover Effects
      document.addEventListener('DOMContentLoaded', function() {
        const demoCards = document.querySelectorAll('.demo-trip-card');

        demoCards.forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
            this.style.boxShadow = '0 15px 40px rgba(0, 0, 0, 0.2)';
          });

          card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
            this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
          });
        });

        // Load stats on page load
        loadPlatformStats();
      });

      // ‚ú® Add some loading animation
      function showLoadingMessage() {
        const facts = [
          "üåê Optimizing your perfect route...",
          "üîç Finding hidden gems nearby...",
          "üìç Calculating travel times...",
          "üí∞ Estimating budget requirements...",
          "üéØ Matching your preferences..."
        ];

        const randomFact = facts[Math.floor(Math.random() * facts.length)];
        return randomFact;
      }
    </script>

    <!-- üí¨ Floating GPT Assistant -->
    <style>
      #chat-toggle {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 50%;
        font-size: 22px;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        transition: all 0.3s ease;
      }

      #chat-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(52, 152, 219, 0.6);
      }

      #chat-box {
        display: none;
        position: fixed;
        bottom: 90px;
        right: 25px;
        width: 350px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        z-index: 999;
        padding: 0;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      #chat-header {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 15px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #chat-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
      }

      #chat-messages {
        max-height: 300px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
      }

      /* Enhanced Chat container bubble styles */
      .chat-message {
        margin: 12px 0;
        padding: 14px 18px;
        border-radius: 18px;
        max-width: 75%;
        line-height: 1.5;
        word-wrap: break-word;
        display: block;
        clear: both;
        position: relative;
        animation: fadeInUp 0.3s ease-out;
        font-size: 14px;
      }

      /* User message (right side) - iMessage blue style */
      .chat-user {
        background-color: #007bff !important;
        color: white !important;
        text-align: left !important;
        margin-left: auto !important;
        margin-right: 8px !important;
        border-top-right-radius: 4px !important;
        border-bottom-right-radius: 18px !important;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3) !important;
        float: right !important;
        clear: both !important;
      }

      /* AI message (left side) - Clean gray style */
      .chat-ai {
        background-color: #f0f0f0 !important;
        color: #333 !important;
        text-align: left !important;
        margin-right: auto !important;
        margin-left: 8px !important;
        border-top-left-radius: 4px !important;
        border-bottom-left-radius: 18px !important;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1) !important;
        float: left !important;
        clear: both !important;
      }

      /* Smooth fade-in animation for new messages */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Enhanced styling for markdown elements */
      .chat-message strong {
        font-weight: 700;
      }

      .chat-message code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: "Monaco", "Consolas", monospace;
        font-size: 0.9em;
      }

      .chat-message ul,
      .chat-message ol {
        margin: 8px 0;
        padding-left: 20px;
      }

      .chat-message li {
        margin: 4px 0;
      }

      #chat-input-container {
        padding: 15px;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
      }

      /* Enhanced input styling */
      #chat-input {
        flex: 1;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        padding: 12px 16px;
        outline: none;
        resize: none;
        height: 40px;
        font-family: inherit;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      #chat-input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      /* Enhanced send button */
      #chat-send {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 42px;
        height: 42px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
      }

      #chat-send:hover:not(:disabled) {
        transform: scale(1.05) rotate(15deg);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
      }

      #chat-send:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .typing-indicator {
        display: none;
        padding: 12px 16px;
        font-style: italic;
        color: #7f8c8d;
        background: #f8f9fa;
        border-radius: 18px;
        margin: 8px 0;
        max-width: 80%;
        margin-right: auto;
        border-top-left-radius: 4px;
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }
    </style>

    <button id="chat-toggle" title="Chat with Trippi - Your Travel Assistant">
      ü§ñ
    </button>

    <div id="chat-box">
      <div id="chat-header">
        <span>üåü Trippi - Your Travel Companion</span>
        <button id="chat-close">√ó</button>
      </div>
      <div id="chat-messages">
        <div class="chat-message chat-ai">
          üëã Hey there! I'm Trippi, your personal travel companion! ‚úàÔ∏è I know
          all about your current trip plans and can help with budgets, places,
          routes, and local tips. What would you like to know? üåê
        </div>
        <div style="clear: both; height: 8px"></div>
      </div>
      <div class="typing-indicator" id="typing-indicator">
        ü§î Trippi is thinking...
      </div>
      <div id="chat-input-container">
        <textarea
          id="chat-input"
          placeholder="Ask Trippi about your trip, budget, places..."
          rows="1"
        ></textarea>
        <button id="chat-send" title="Send message to Trippi">‚û§</button>
      </div>
    </div>

    <script>
      // Chat toggle functionality
      document.getElementById("chat-toggle").onclick = () => {
        const box = document.getElementById("chat-box");
        box.style.display = box.style.display === "block" ? "none" : "block";
      };

      document.getElementById("chat-close").onclick = () => {
        document.getElementById("chat-box").style.display = "none";
      };

      // Auto-resize textarea
      document
        .getElementById("chat-input")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });

      // Send on Enter (but not Shift+Enter)
      document
        .getElementById("chat-input")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChat();
          }
        });

      document.getElementById("chat-send").onclick = sendChat;

      async function sendChat() {
        const input = document.getElementById("chat-input");
        const sendBtn = document.getElementById("chat-send");
        const messages = document.getElementById("chat-messages");
        const typing = document.getElementById("typing-indicator");

        const msg = input.value.trim();
        if (!msg) return;

        // Enhanced message rendering with markdown support
        function renderMessage(text, isUser = false) {
          // Simple markdown parsing for common patterns
          let rendered = text
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/`(.*?)`/g, "<code>$1</code>")
            .replace(/\n/g, "<br>");

          return rendered;
        }

        // Auto-scroll function with smooth animation
        function scrollToBottom() {
          const chatBox = document.getElementById("chat-messages");
          chatBox.scrollTo({
            top: chatBox.scrollHeight,
            behavior: "smooth",
          });
        }

        // Add user message with enhanced styling and markdown
        const userMessage = renderMessage(msg, true);
        messages.innerHTML += `<div class="chat-message chat-user">${userMessage}</div><div style="clear: both; height: 8px;"></div>`;

        input.value = "";
        input.style.height = "auto";
        sendBtn.disabled = true;
        typing.style.display = "block";

        // Smooth scroll to bottom after user message
        scrollToBottom();

        try {
          // Prepare comprehensive trip context for Trippi
          const tripContext = {
            city: "{{ city if city else '' }}",
            places: window.placesData || [],
            budget_estimate: window.budgetEstimate || null,
            total_distance: window.totalDistance || null,
            total_duration: window.totalDuration || null,
            gpt_prompt: "{{ gpt_prompt if gpt_prompt else '' }}",
            polyline: window.routePolyline || "",
          };

          // Only send context if we actually have trip data
          const hasValidContext =
            tripContext.city &&
            tripContext.places &&
            tripContext.places.length > 0;

          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: msg,
              trip_context: hasValidContext ? tripContext : null,
            }),
          });

          const data = await res.json();

          // Add AI response with enhanced styling and markdown parsing
          if (data.error) {
            messages.innerHTML += `<div class="chat-message chat-ai" style="color: #e74c3c;">‚ùå ${data.error}</div><div style="clear: both; height: 8px;"></div>`;
          } else {
            const answer =
              data.answer || "Sorry, I couldn't process that request.";
            const aiMessage = renderMessage(answer, false);

            // Add special styling if Trippi has trip context
            const contextIndicator = data.has_trip_context
              ? `<div style="font-size: 11px; color: #7f8c8d; margin-bottom: 8px;">üìä <em>Trippi knows about your ${
                  tripContext.city || "current"
                } trip</em></div>`
              : "";

            messages.innerHTML += `<div class="chat-message chat-ai">${contextIndicator}${aiMessage}</div><div style="clear: both; height: 8px;"></div>`;
          }
        } catch (error) {
          console.error("Chat error:", error);
          messages.innerHTML += `<div class="chat-message chat-ai">Sorry, something went wrong. Please try again! üòû</div><div style="clear: both; height: 8px;"></div>`;
        } finally {
          typing.style.display = "none";
          sendBtn.disabled = false;

          // Smooth scroll to bottom after AI response
          setTimeout(() => {
            scrollToBottom();
          }, 100); // Small delay to ensure content is rendered
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
  </body>
</html>
